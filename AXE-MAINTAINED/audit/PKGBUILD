# $Id: PKGBUILD 79970 2012-11-15 08:39:27Z mtorromeo $
# Maintainer: Jubei-Mitsuyoshi <jubei.house.of.five.masters@gmail.com>
# Maintainer: Massimiliano Torromeo <massimiliano.torromeo@gmail.com>
# Contributor: Connor Behan <connor.behan@gmail.com>
# Contributor: henning mueller <henning@orgizm.net>

pkgname=audit
pkgver=2.2.1
_arch_rel=4
_axe_rel=1

pkgrel="${_AXE_PREFIX_REL}.${_AXE_STAGE}.${_arch_rel}.${_axe_rel}.${_AXE_PROCESOR_REL}.${_AXE_SUFFIX_REL}"
pkgdesc='User space utilities for storing and searching the audit records generated by the audit subsystem in the Linux kernel.'
url=http://people.redhat.com/sgrubb/$pkgname
arch=(i686 x86_64)
depends=(krb5 libcap-ng)
makedepends=(libldap swig linux-headers python2)
license=(GPL)
groups=("axis")
options=(!libtool emptydirs)
backup=(
	etc/libaudit.conf
	etc/audit/audit.rules
	etc/audit/auditd.conf
	etc/audisp/audispd.conf
	etc/audisp/audisp-remote.conf
	etc/audisp/zos-remote.conf
	etc/audisp/plugins.d/af_unix.conf
	etc/audisp/plugins.d/audispd-zos-remote.conf
	etc/audisp/plugins.d/au-remote.conf
	etc/audisp/plugins.d/syslog.conf
)
source=(
	$url/$pkgname-$pkgver.tar.gz
	auditd.rc
	auditd.service
	python2.patch
)

build() {
	cd "$srcdir/$pkgname-$pkgver"
	patch -p0 -i "$srcdir/python2.patch"
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--libexecdir=/usr/lib/audit \
		--with-python=yes \
		--enable-gssapi-krb5=yes \
		--with-libcap-ng=yes #--with-apparmor=yes
	make
}

package() {
	cd "$srcdir/$pkgname-$pkgver"
	make DESTDIR="$pkgdir" install

#	install -Dm755 "$srcdir/auditd.service" "$pkgdir/usr/lib/systemd/system/auditd.service"

	cd "$pkgdir"
	install -m755 "$srcdir/auditd.rc" etc/rc.d/auditd
	install -d var/log/audit
	rm -rf etc/rc.d/init.d etc/sysconfig

	sed -ri 's| /sbin| /usr/sbin|' etc/audit/*.conf etc/audisp/plugins.d/*.conf
}

sha256sums=('9865ca89f5b975ccf25441ddf45a874448f2bba944005aa8cd5e3c3148713a63'
            '781698ab5b17b3416d5e0ff5d4cf14a6c8b4a22d2933657699b137f4a26d54a4'
            '3c7179f40216b594675f26bb73884406c8ac91577b609dd1ab9837f889954007'
            'e60c031c6354f41938447c439eadee77127307687a2c487a54fab884eeafd9c2')
#----------------axe warning------------------ syetemd detected in file /root/axebuilder/AxePkgbuildsUpdatable/audit/PKGBUILD 
#----------------axe warning------------------ /root/axebuilder/AxePkgbuildsUpdatable/audit/auditd.rc altered for rc.d changes
#--axe-note-- axe is following upgpkg: audit 2.2.1-4 Fixed paths in configuration files after move from /sbin to /usr/sbin
